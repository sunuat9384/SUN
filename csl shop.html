<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSL Shop Locations Map</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background: #f0f0f0;
            font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Title Overlay specifically for PPT style */
        .title-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 5px solid #FF6600; /* CSL Orange tone */
        }

        .title-overlay h1 {
            margin: 0;
            font-size: 24px;
            color: #333;
        }
        
        .title-overlay p {
            margin: 5px 0 0 0;
            font-size: 14px;
            color: #666;
        }

        /* Replay Button */
        #replay-btn {
            position: absolute;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            background: #FF6600; /* CSL Orange tone */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background 0.3s;
        }

        #replay-btn:hover {
            background: #e65c00;
        }

        /* The Pin Icon Styling */
        .custom-pin {
            background: transparent;
            border: none;
        }

        /* Falling Animation Keyframes */
        @keyframes dropIn {
            0% {
                opacity: 0;
                transform: translateY(-500px) scale(0.5);
            }
            60% {
                opacity: 1;
                transform: translateY(20px) scale(1.1);
            }
            80% {
                transform: translateY(-10px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Class to trigger animation */
        .pin-falling {
            /* The animation will be applied via JS to control delay */
        }
        
        .pin-icon-svg {
            filter: drop-shadow(3px 5px 2px rgba(0,0,0,0.4));
        }

    </style>
</head>
<body>

    <div class="title-overlay">
        <h1>CSL 門市分佈圖</h1>
        <p></p>
    </div>

    <div id="map"></div>
    <button id="replay-btn" onclick="startAnimation()">重播動畫 (Replay)</button>

    <script>
        // 1. Initialize Map
        // Centered on Hong Kong
        const map = L.map('map', {
            zoomControl: false, // Cleaner look for PPT
            attributionControl: false // Cleaner look
        }).setView([22.35, 114.14], 11);

        // Add a clean, Google-Maps-like tile layer (CartoDB Voyager)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            subdomains: 'abcd',
        }).addTo(map);

        // 2. Data Preparation
        // Mapping district keywords to approximate coordinates (Lat, Lng)
        // Adding a small random jitter so pins in the same district don't overlap perfectly
        const locationMap = {
            "尖沙咀": [22.2980, 114.1730],
            "九龍灣": [22.3230, 114.2140],
            "上水": [22.5030, 114.1280],
            "大角咀": [22.3170, 114.1630], // 奥海城
            "大埔": [22.4508, 114.1642],
            "中環": [22.2825, 114.1570],
            "元朗": [22.4430, 114.0280],
            "天水圍": [22.4580, 114.0040],
            "太古城": [22.2810, 114.2230],
            "屯門": [22.3920, 113.9750],
            "北角": [22.2910, 114.2000],
            "佐敦": [22.3050, 114.1700],
            "大圍": [22.3730, 114.1780],
            "沙田": [22.3820, 114.1880],
            "旺角": [22.3193, 114.1694],
            "青衣城": [22.3580, 114.1070],
            "紅磡": [22.3050, 114.1860],
            "香港仔": [22.2480, 114.1540],
            "柴灣": [22.2640, 114.2370],
            "粉嶺": [22.4920, 114.1420],
            "荃灣": [22.3700, 114.1140],
            "馬鞍山": [22.4240, 114.2310],
            "將軍澳": [22.3080, 114.2600],
            "深水埗": [22.3300, 114.1610],
            "黃大仙": [22.3420, 114.1930],
            "葵芳": [22.3570, 114.1270],
            "銅鑼灣": [22.2800, 114.1850],
            "鰂魚涌": [22.2860, 114.2120],
            "灣仔": [22.2760, 114.1730],
            "觀塘": [22.3120, 114.2250],
            "鑽石山": [22.3400, 114.2020]
        };

        const rawAddresses = [
            "九龍 尖沙咀柯士甸道西 1 號圓方二樓 2001A 號鋪",
            "九龍灣德福廣場 P45-47 號商店",
            "上水新都廣場245-247舖",
            "大角咀奧海城 2 期地下高層 70A 舖",
            "大埔超級城 A 區 14-15 號商店",
            "中環皇后大道中31號/戲院里3號陸海通大廈地下2A1舖",
            "元朗青山公路 175 號澤榮閣地下 A 舖",
            "元朗教育路 1 號元朗千色匯地下 10 – 11 號舖",
            "天水圍天耀廣場 地下 L053A 號商店",
            "太古城太古城道 18 號太古城中心1樓 151B 舖",
            "屯門 V city MTR 層 M-10 號舖",
            "屯門市廣場第一期地下 G127-G128 號舖",
            "北角英皇道 193-209 號 英皇中心地下 3 號舖",
            "尖沙咀金馬倫道 12, 12A 號, 恆信商業大廈地舖",
            "佐敦佐敦道 20-24 號鴻運大廈地下 E 舖",
            "沙田大圍車公廟路18號圍方5樓523A 舖",
            "沙田沙田廣場第 3 層 14 & 15A 號舖",
            "旺角西洋菜南街 2J-2Q，新江大樓 1 樓及地下 8 號舖",
            "旺角彌敦道 750 號始創中心地下 G21 及 22A 號舖",
            "青衣城一樓 132 號商店",
            "紅磡德民街 36-60 號地下 7B 商店",
            "香港仔湖北街 18 號地下及閣樓",
            "柴灣新翠商場第一層 113A 舖",
            "粉嶺車站路18號名都商埸2樓46號鋪",
            "荃灣眾安街 26-40 號合眾大廈地下 1A & 1B 號舖",
            "荃灣眾安街53號地下",
            "馬鞍山新港城中心商場三樓 3208 號舖",
            "將軍澳唐俊街 9 號 Popcorn 二期一樓 F73 號舖",
            "將軍澳新都城二期地下上層 29-30 號店",
            "深水埗福華街 132-134 號地下 C3及D 舖",
            "黃大仙黃大仙下邨黃大仙中心南館地下高層 UG26A 商店",
            "葵芳新都會廣場 1 樓 139A 號舖",
            "葵芳葵涌廣場 2 樓 117 舖",
            "銅鑼灣怡和街22號1樓，2樓及地下1 & 2 號舖",
            "鰂魚涌英皇道 979 號 太古坊 電訊盈科中心 14 樓",
            "灣仔莊士敦道 135 號東興大廈地下 F 號舖",
            "觀塘開源道68號觀塘廣場地下 G11 號舖",
            "鑽石山荷里活廣場2樓246號舖"
        ];

        // Process data to get coordinates
        const shops = [];
        rawAddresses.forEach(addr => {
            let foundCoord = null;
            // Simple keyword matching
            for (const [key, coord] of Object.entries(locationMap)) {
                if (addr.includes(key)) {
                    // Add slight random jitter so markers don't stack exactly on top of each other
                    // about +/- 0.003 degrees (~300m)
                    const lat = coord[0] + (Math.random() - 0.5) * 0.008;
                    const lng = coord[1] + (Math.random() - 0.5) * 0.008;
                    foundCoord = [lat, lng];
                    break;
                }
            }
            if (foundCoord) {
                shops.push({ address: addr, lat: foundCoord[0], lng: foundCoord[1] });
            } else {
                // Default fallback center if detection fails 
                const lat = 22.3193 + (Math.random() - 0.5) * 0.1;
                const lng = 114.1694 + (Math.random() - 0.5) * 0.1;
                shops.push({ address: addr, lat: lat, lng: lng });
            }
        });

        // 3. Create Custom Orange Pin Icon
        // Using an SVG string to ensure it's orange and sharp
        const svgIcon = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FF6600" width="40" height="40" stroke="white" stroke-width="1.5">
                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
            </svg>
        `;

        const markers = [];

        function startAnimation() {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers.length = 0;

            // Randomize order slightly for more natural "rain" effect
            const shuffledShops = [...shops].sort(() => 0.5 - Math.random());

            shuffledShops.forEach((shop, index) => {
                // Calculate delay: Fast drop (entire sequence in about 2-3 seconds)
                const delay = index * 60; // 60ms delay between each pin

                const myIcon = L.divIcon({
                    className: 'custom-pin',
                    html: `<div class="pin-icon-svg" style="animation: dropIn 0.8s cubic-bezier(0.25, 1, 0.5, 1) forwards; animation-delay: ${delay}ms; opacity: 0; transform: translateY(-500px);">
                            ${svgIcon}
                           </div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 40], // Tip of the pin
                    popupAnchor: [0, -40]
                });

                const marker = L.marker([shop.lat, shop.lng], { icon: myIcon }).addTo(map);
                
                // Add Popup
                marker.bindPopup(`<b style="color:#FF6600">CSL</b><br>${shop.address}`);
                
                markers.push(marker);
            });
        }

        // Start animation on load
        window.onload = () => {
            setTimeout(startAnimation, 500); // Small buffer to let tiles load
        };

    </script>
</body>
</html>